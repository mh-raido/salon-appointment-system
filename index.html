<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エステ予約管理システム</title>
    <!-- Firebase SDK の追加 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        h1 {
            color: #d6628f;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 30px;
        }
        .day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .day {
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            position: relative;
        }
        .today {
            background-color: #f8f1f5;
            border: 2px solid #d6628f;
        }
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            text-align: right;
        }
        .appointment {
            background-color: #e1f5fe;
            border-left: 3px solid #29b6f6;
            padding: 5px;
            margin-bottom: 5px;
            border-radius: 2px;
            font-size: 14px;
            cursor: pointer;
        }
        .appointment:hover {
            background-color: #b3e5fc;
        }
        button {
            background-color: #d6628f;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #c15580;
        }
        button.secondary {
            background-color: #6c757d;
        }
        button.danger {
            background-color: #dc3545;
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .search-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .monthly-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .month-display {
            font-size: 20px;
            font-weight: bold;
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .tab.active {
            border: 1px solid #ddd;
            border-bottom: 1px solid white;
            border-radius: 4px 4px 0 0;
            margin-bottom: -1px;
            background-color: white;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        .client-list {
            margin-top: 20px;
        }
        .client-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: white;
        }
        .client-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .client-info {
            margin-bottom: 10px;
        }
        .client-appointments {
            margin-top: 10px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #d6628f;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
        }
        /* モーダル用スタイル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .helper-text {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .notification {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .loading-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #d6628f;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sync-status {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
            margin-top: 20px;
        }
        .user-info {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
        }
        .user-email {
            font-size: 14px;
            margin-right: 10px;
        }
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .calendar {
                display: block;
            }
            .day-header {
                display: none;
            }
            .day {
                margin-bottom: 10px;
                min-height: auto;
            }
            .day::before {
                content: attr(data-day);
                font-weight: bold;
                display: block;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- ローディング表示 -->
    <div id="loading" class="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>データを読み込み中...</p>
        </div>
    </div>

    <!-- ログイン画面 -->
    <div id="login-container" class="login-container" style="display: none;">
        <h2>エステ予約管理システム</h2>
        <p>サロンデータにアクセスするにはサインインしてください</p>
        <div id="login-error" class="notification error" style="display: none;"></div>
        <div class="form-group">
            <label for="email">メールアドレス</label>
            <input type="email" id="email" placeholder="メールアドレスを入力">
        </div>
        <div class="form-group">
            <label for="password">パスワード</label>
            <input type="password" id="password" placeholder="パスワードを入力">
        </div>
        <button id="signin-btn">サインイン</button>
        <p>アカウントをお持ちでない場合は、管理者にお問い合わせください。</p>
    </div>

    <!-- メインアプリコンテンツ -->
    <div id="app-container" class="container" style="display: none;">
        <div class="user-info">
            <span id="user-email" class="user-email"></span>
            <button id="signout-btn" class="secondary">サインアウト</button>
        </div>

        <h1>エステ予約管理システム</h1>
        <div id="notification" class="notification" style="display: none;"></div>
        
        <div class="tab-container">
            <div class="tabs">
                <div class="tab active" onclick="openTab(event, 'calendar-tab')">カレンダー</div>
                <div class="tab" onclick="openTab(event, 'clients-tab')">顧客管理</div>
                <div class="tab" onclick="openTab(event, 'stats-tab')">統計</div>
            </div>
            
            <div id="calendar-tab" class="tab-content active">
                <div class="monthly-nav">
                    <div class="month-display" id="current-month">2025年5月</div>
                    <div class="controls">
                        <button onclick="previousMonth()">前月</button>
                        <button onclick="nextMonth()">翌月</button>
                        <button onclick="goToToday()">今日</button>
                    </div>
                </div>
                
                <div class="search-container">
                    <input type="text" id="appointment-search" placeholder="予約を検索...">
                    <button onclick="searchAppointments()">検索</button>
                    <button onclick="showAppointmentModal()">新規予約</button>
                </div>
                
                <div class="calendar" id="calendar-grid">
                    <div class="day-header">日</div>
                    <div class="day-header">月</div>
                    <div class="day-header">火</div>
                    <div class="day-header">水</div>
                    <div class="day-header">木</div>
                    <div class="day-header">金</div>
                    <div class="day-header">土</div>
                    <!-- Calendar days will be generated by JavaScript -->
                </div>
            </div>
            
            <div id="clients-tab" class="tab-content">
                <div class="search-container">
                    <input type="text" id="client-search" placeholder="顧客を検索...">
                    <button onclick="searchClients()">検索</button>
                    <button onclick="showClientModal()">新規顧客</button>
                </div>
                
                <div class="client-list" id="client-list">
                    <!-- Clients will be generated by JavaScript -->
                </div>
            </div>
            
            <div id="stats-tab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">今月の予約数</div>
                        <div class="stat-number" id="monthly-appointments">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">顧客総数</div>
                        <div class="stat-number" id="total-clients">0</div>
                    </div>
                </div>
                
                <h3>日別予約数</h3>
                <canvas id="appointments-chart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="sync-status" id="sync-status">
            同期状態: オフライン
        </div>
    </div>
    
    <!-- 予約追加・編集モーダル -->
    <div id="appointment-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAppointmentModal()">&times;</span>
            <h2 id="appointment-modal-title">新規予約</h2>
            
            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label for="client-name">顧客名</label>
                        <input type="text" id="client-name" required>
                    </div>
                    <div class="form-group">
                        <label for="client-phone">電話番号</label>
                        <input type="tel" id="client-phone" placeholder="ハイフンなしで入力" required>
                        <div class="helper-text">※ハイフンなしで入力（例：09012345678）</div>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="appointment-date">日付</label>
                        <input type="date" id="appointment-date" required>
                    </div>
                    <div class="form-group">
                        <label for="appointment-time">時間</label>
                        <input type="time" id="appointment-time" required>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="appointment-notes">メモ</label>
                <textarea id="appointment-notes" rows="3" placeholder="施術内容、特記事項などを記入"></textarea>
            </div>
            
            <div>
                <button id="save-appointment-btn" onclick="saveAppointment()">保存</button>
                <button class="secondary" onclick="closeAppointmentModal()">キャンセル</button>
                <button class="danger" id="appointment-delete-btn" onclick="deleteAppointment()" style="display: none;">削除</button>
            </div>
        </div>
    </div>
    
    <!-- 顧客追加・編集モーダル -->
    <div id="client-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeClientModal()">&times;</span>
            <h2 id="client-modal-title">顧客情報</h2>
            
            <div class="form-group">
                <label for="modal-client-name">顧客名</label>
                <input type="text" id="modal-client-name" required>
            </div>
            <div class="form-group">
                <label for="modal-client-name-yomi">顧客名（よみ）</label>
                <input type="text" id="modal-client-name-yomi" placeholder="ひらがなで入力" required>
                <div class="helper-text">※あいうえお順の並び替えに使用します</div>
            </div>
            <div class="form-group">
                <label for="modal-client-phone">電話番号</label>
                <input type="tel" id="modal-client-phone" placeholder="ハイフンなしで入力" required>
                <div class="helper-text">※ハイフンなしで入力（例：09012345678）</div>
            </div>
            <div class="form-group">
                <label for="modal-client-notes">顧客メモ</label>
                <textarea id="modal-client-notes" rows="3" placeholder="肌質、施術の好み、アレルギーなどの特記事項"></textarea>
            </div>
            
            <div>
                <button id="save-client-btn" onclick="saveClient()">保存</button>
                <button class="secondary" onclick="closeClientModal()">キャンセル</button>
                <button class="danger" id="client-delete-btn" onclick="deleteClient()" style="display: none;">削除</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyAnEvBoL7PkurhziOKCsnRfyvmhHxmLsRU",
            authDomain: "spa-yume-system.firebaseapp.com",
            projectId: "spa-yume-system",
            storageBucket: "spa-yume-system.appspot.com",
            messagingSenderId: "77136643304",
            appId: "1:77136643304:web:077773f33995448dec755d"
        };

        // Firebaseの初期化
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // データ保存用の変数
        let appointments = [];
        let clients = [];
        let currentAppointment = null;
        let currentClient = null;
        
        // 現在表示中の月
        let currentMonth = new Date();
        
        // リアルタイム更新リスナー
        let appointmentsUnsubscribe = null;
        let clientsUnsubscribe = null;
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 認証状態のリスナーを設定
            auth.onAuthStateChanged(user => {
                const loading = document.getElementById('loading');
                const loginContainer = document.getElementById('login-container');
                const appContainer = document.getElementById('app-container');
                
                if (user) {
                    // ユーザーがログインしている場合
                    console.log("User signed in:", user.email);
                    document.getElementById('user-email').textContent = user.email;
                    
                    // コンテンツを表示
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    
                    // データのリアルタイムリスナーを設定
                    setupRealtimeListeners();
                    
                    // サンプルデータ作成の試行
                    createSampleData();
                    
                    // カレンダーとクライアントリストをレンダリング
                    renderCalendar();
                    updateStats();
                    
                    // 同期状態を更新
                    updateSyncStatus('オンライン - 同期中');
                } else {
                    // ユーザーがログインしていない場合
                    console.log("No user signed in");
                    
                    // ログイン画面を表示
                    loginContainer.style.display = 'block';
                    appContainer.style.display = 'none';
                    
                    // リスナーをクリーンアップ
                    cleanupRealtimeListeners();
                }
                
                // ローディング表示を非表示
                loading.style.display = 'none';
            });
            
            // ログインボタンのイベントリスナー
            document.getElementById('signin-btn').addEventListener('click', function() {
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('login-error');
                
                if (!email || !password) {
                    loginError.textContent = 'メールアドレスとパスワードを入力してください。';
                    loginError.style.display = 'block';
                    return;
                }
                
                // ローディング表示
                document.getElementById('loading').style.display = 'flex';
                
                // ログイン処理
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        console.error("Error signing in:", error);
                        document.getElementById('loading').style.display = 'none';
                        
                        let errorMessage = 'ログインに失敗しました。';
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                            errorMessage = 'メールアドレスまたはパスワードが間違っています。';
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = '有効なメールアドレスを入力してください。';
                        } else if (error.code === 'auth/too-many-requests') {
                            errorMessage = 'ログイン試行回数が多すぎます。しばらく経ってからお試しください。';
                        }
                        
                        loginError.textContent = errorMessage;
                        loginError.style.display = 'block';
                    });
            });
            
            // サインアウトボタンのイベントリスナー
            document.getElementById('signout-btn').addEventListener('click', function() {
                auth.signOut()
                    .then(() => {
                        console.log("User signed out");
                    })
                    .catch(error => {
                        console.error("Error signing out:", error);
                        showNotification('サインアウトに失敗しました。', 'error');
                    });
            });
        });
        
        // リアルタイムリスナーの設定
        function setupRealtimeListeners() {
            // 予約データのリスナー
            appointmentsUnsubscribe = db.collection('appointments')
                .onSnapshot(snapshot => {
                    const changes = snapshot.docChanges();
                    
                    changes.forEach(change => {
                        const data = change.doc.data();
                        const appointment = {
                            id: change.doc.id,
                            clientName: data.clientName,
                            phone: data.phone,
                            date: data.date,
                            time: data.time,
                            notes: data.notes || ''
                        };
                        
                        if (change.type === 'added') {
                            // 新しい予約が追加された
                            const existingIndex = appointments.findIndex(apt => apt.id === appointment.id);
                            if (existingIndex === -1) {
                                appointments.push(appointment);
                            }
                        } else if (change.type === 'modified') {
                            // 予約が更新された
                            const index = appointments.findIndex(apt => apt.id === appointment.id);
                            if (index !== -1) {
                                appointments[index] = appointment;
                            }
                        } else if (change.type === 'removed') {
                            // 予約が削除された
                            appointments = appointments.filter(apt => apt.id !== appointment.id);
                        }
                    });
                    
                    // UIを更新
                    renderCalendar();
                    updateStats();
                    
                    // 同期状態を更新
                    updateSyncStatus('オンライン - 同期完了');
                }, error => {
                    console.error("Appointments listener error:", error);
                    updateSyncStatus('エラー - 再接続中');
                });
            
            // 顧客データのリスナー
            clientsUnsubscribe = db.collection('clients')
                .onSnapshot(snapshot => {
                    const changes = snapshot.docChanges();
                    
                    changes.forEach(change => {
                        const data = change.doc.data();
                        const client = {
                            id: change.doc.id,
                            name: data.name,
                            nameYomi: data.nameYomi || '',
                            phone: data.phone,
                            notes: data.notes || ''
                        };
                        
                        if (change.type === 'added') {
                            // 新しい顧客が追加された
                            const existingIndex = clients.findIndex(c => c.id === client.id);
                            if (existingIndex === -1) {
                                clients.push(client);
                            }
                        } else if (change.type === 'modified') {
                            // 顧客が更新された
                            const index = clients.findIndex(c => c.id === client.id);
                            if (index !== -1) {
                                clients[index] = client;
                            }
                        } else if (change.type === 'removed') {
                            // 顧客が削除された
                            clients = clients.filter(c => c.id !== client.id);
                        }
                    });
                    
                    // UIを更新
                    renderClients();
                    updateStats();
                    
                    // 同期状態を更新
                    updateSyncStatus('オンライン - 同期完了');
                }, error => {
                    console.error("Clients listener error:", error);
                    updateSyncStatus('エラー - 再接続中');
                });
        }
        
        // リアルタイムリスナーのクリーンアップ
        function cleanupRealtimeListeners() {
            if (appointmentsUnsubscribe) {
                appointmentsUnsubscribe();
                appointmentsUnsubscribe = null;
            }
            
            if (clientsUnsubscribe) {
                clientsUnsubscribe();
                clientsUnsubscribe = null;
            }
            
            // データをクリア
            appointments = [];
            clients = [];
        }
        
        // 同期状態の更新
        function updateSyncStatus(status) {
            const syncStatus = document.getElementById('sync-status');
            syncStatus.textContent = `同期状態: ${status}`;
        }
        
        // 通知表示
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            // 3秒後に非表示
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // 電話番号からハイフンを削除する関数
        function cleanPhoneNumber(phone) {
            return phone ? phone.replace(/-/g, '') : '';
        }
        
        // 日付をYYYY-MM-DD形式にフォーマットする関数（タイムゾーン問題を修正）
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // カレンダー関連の関数
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthDisplay = document.getElementById('current-month');
            
            // ヘッダー以外の日付をクリア
            while (calendarGrid.children.length > 7) {
                calendarGrid.removeChild(calendarGrid.lastChild);
            }
            
            // 月表示を設定
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            monthDisplay.textContent = `${year}年${month + 1}月`;
            
            // 月の最初の日と日数を取得
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const numDays = lastDay.getDate();
            
            // 月の最初の日の前の空白セルを追加
            const firstDayOfWeek = firstDay.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'day empty';
                calendarGrid.appendChild(emptyDay);
            }
            
            // 今日の日付をハイライト表示するための準備
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            const todayDate = today.getDate();
            
            // カレンダーの日付を作成
            for (let day = 1; day <= numDays; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'day';
                dayElement.setAttribute('data-day', `${year}-${month + 1}-${day}`);
                
                // 今日の日付をハイライト
                if (isCurrentMonth && day === todayDate) {
                    dayElement.classList.add('today');
                }
                
                // 日付番号を追加
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);
                
                // クリックイベントで予約追加
                dayElement.addEventListener('click', function(e) {
                    // 日付自体をクリックした場合のみ（予約部分はスキップ）
                    if (e.target === dayElement || e.target === dayNumber) {
                        const selectedDate = new Date(year, month, day);
                        showAppointmentModal(selectedDate);
                    }
                });
                
                calendarGrid.appendChild(dayElement);
            }
            
            // 予約を表示
            displayAppointments();
        }
        
        function displayAppointments() {
            // カレンダーから既存の予約表示をクリア
            document.querySelectorAll('.appointment').forEach(el => el.remove());
            
            // 現在の月の予約をフィルタリング
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            const filteredAppointments = appointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate.getFullYear() === year && aptDate.getMonth() === month;
            });
            
            // 予約をカレンダーに追加
            filteredAppointments.forEach(appointment => {
                const appointmentDate = new Date(appointment.date);
                const day = appointmentDate.getDate();
                
                // 該当する日付の要素を見つける
                const daySelector = `[data-day="${year}-${month + 1}-${day}"]`;
                const dayElement = document.querySelector(daySelector);
                
                if (dayElement) {
                    const appointmentEl = document.createElement('div');
                    appointmentEl.className = 'appointment';
                    appointmentEl.setAttribute('data-id', appointment.id);
                    
                    // 時間のフォーマット
                    const timeDisplay = appointment.time.substring(0, 5);
                    
                    // 予約内容の表示
                    appointmentEl.innerHTML = `
                        <strong>${timeDisplay}</strong> ${appointment.clientName}
                    `;
                    
                    // クリックで編集
                    appointmentEl.addEventListener('click', function(e) {
                        e.stopPropagation(); // 日付クリックイベントの伝播を停止
                        editAppointment(appointment.id);
                    });
                    
                    dayElement.appendChild(appointmentEl);
                }
            });
        }
        
        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        }
        
        function goToToday() {
            currentMonth = new Date();
            renderCalendar();
        }
        
        // 予約モーダル関連の関数
        function showAppointmentModal(date) {
            const modal = document.getElementById('appointment-modal');
            modal.style.display = 'block';
            
            // フォームをリセット
            document.getElementById('appointment-modal-title').textContent = '新規予約';
            document.getElementById('client-name').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('appointment-notes').value = '';
            document.getElementById('appointment-delete-btn').style.display = 'none';
            
            // 日付が指定されていれば、その日付をセット（タイムゾーン問題修正）
            if (date) {
                const formattedDate = formatDate(date); // 新しいフォーマット関数を使用
                document.getElementById('appointment-date').value = formattedDate;
            } else {
                // 今日の日付をデフォルトに
                const today = new Date();
                document.getElementById('appointment-date').value = formatDate(today);
            }
            
            // デフォルト時間を現在の時間の次の時間に
            const now = new Date();
            now.setHours(now.getHours() + 1);
            now.setMinutes(0);
            const formattedTime = now.toTimeString().substring(0, 5);
            document.getElementById('appointment-time').value = formattedTime;
            
            // 編集中の予約をクリア
            currentAppointment = null;
        }
        
        function closeAppointmentModal() {
            document.getElementById('appointment-modal').style.display = 'none';
            currentAppointment = null;
        }
        
        function editAppointment(appointmentId) {
            // 予約を検索
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;
            
            // 編集対象の予約を保存
            currentAppointment = appointment;
            
            // モーダルタイトルを更新
            document.getElementById('appointment-modal-title').textContent = '予約編集';
            
            // フォームに値をセット
            document.getElementById('client-name').value = appointment.clientName;
            document.getElementById('client-phone').value = appointment.phone || '';
            document.getElementById('appointment-date').value = appointment.date;
            document.getElementById('appointment-time').value = appointment.time;
            document.getElementById('appointment-notes').value = appointment.notes || '';
            
            // 削除ボタンを表示
            document.getElementById('appointment-delete-btn').style.display = 'inline-block';
            
            // モーダルを表示
            document.getElementById('appointment-modal').style.display = 'block';
        }
        
        function saveAppointment() {
            // ボタンを無効化して多重送信を防止
            document.getElementById('save-appointment-btn').disabled = true;
            
            // フォームから値を取得
            const clientName = document.getElementById('client-name').value.trim();
            const phone = cleanPhoneNumber(document.getElementById('client-phone').value.trim());
            const date = document.getElementById('appointment-date').value;
            const time = document.getElementById('appointment-time').value;
            const notes = document.getElementById('appointment-notes').value.trim();
            
            // 必須項目のバリデーション
            if (!clientName || !phone || !date || !time) {
                alert('顧客名、電話番号、日付、時間は必須です。');
                document.getElementById('save-appointment-btn').disabled = false;
                return;
            }
            
            // 予約データの準備
            const appointmentData = {
                clientName,
                phone,
                date,
                time,
                notes,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Firebase保存処理を開始
            let savePromise;
            
            if (currentAppointment) {
                // 既存の予約を更新
                savePromise = db.collection('appointments').doc(currentAppointment.id).update(appointmentData);
            } else {
                // 新規予約を作成
                appointmentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                savePromise = db.collection('appointments').add(appointmentData);
            }
            
            savePromise
                .then(() => {
                    // 顧客が存在しなければ追加
                    const clientExists = clients.some(client => client.phone === phone);
                    
                    if (!clientExists) {
                        // 顧客データを一時的に保存して、顧客情報入力モーダルを表示
                        const tempClient = {
                            name: clientName,
                            phone
                        };
                        
                        // 予約保存後、顧客情報入力モーダルを表示
                        closeAppointmentModal();
                        showNewClientModal(tempClient);
                    } else {
                        // 予約保存成功通知
                        showNotification(currentAppointment ? '予約を更新しました。' : '新規予約を追加しました。');
                        closeAppointmentModal();
                    }
                })
                .catch(error => {
                    console.error("Error saving appointment:", error);
                    alert('予約の保存に失敗しました。再度お試しください。');
                })
                .finally(() => {
                    // ボタンを再有効化
                    document.getElementById('save-appointment-btn').disabled = false;
                });
        }
        
        function deleteAppointment() {
            if (!currentAppointment) return;
            
            if (confirm('この予約を削除してもよろしいですか？')) {
                // ボタンを無効化
                document.getElementById('appointment-delete-btn').disabled = true;
                
                // Firebaseから予約を削除
                db.collection('appointments').doc(currentAppointment.id).delete()
                    .then(() => {
                        showNotification('予約を削除しました。');
                        closeAppointmentModal();
                    })
                    .catch(error => {
                        console.error("Error deleting appointment:", error);
                        alert('予約の削除に失敗しました。再度お試しください。');
                    })
                    .finally(() => {
                        // ボタンを再有効化
                        document.getElementById('appointment-delete-btn').disabled = false;
                    });
            }
        }
        
        function searchAppointments() {
            const searchTerm = document.getElementById('appointment-search').value.trim().toLowerCase();
            
            if (!searchTerm) {
                renderCalendar();
                return;
            }
            
            // カレンダーから既存の予約表示をクリア
            document.querySelectorAll('.appointment').forEach(el => el.remove());
            
            // 予約を検索
            const filteredAppointments = appointments.filter(apt => 
                apt.clientName.toLowerCase().includes(searchTerm) ||
                (apt.notes && apt.notes.toLowerCase().includes(searchTerm)) ||
                (apt.phone && apt.phone.includes(searchTerm))
            );
            
            // 検索結果をハイライト表示
            filteredAppointments.forEach(appointment => {
                const appointmentDate = new Date(appointment.date);
                const year = appointmentDate.getFullYear();
                const month = appointmentDate.getMonth() + 1;
                const day = appointmentDate.getDate();
                
                // 該当する日付の要素を見つける
                const daySelector = `[data-day="${year}-${month}-${day}"]`;
                const dayElement = document.querySelector(daySelector);
                
                if (dayElement) {
                    const appointmentEl = document.createElement('div');
                    appointmentEl.className = 'appointment';
                    appointmentEl.setAttribute('data-id', appointment.id);
                    appointmentEl.style.backgroundColor = '#ffeb3b'; // ハイライト表示
                    
                    // 時間のフォーマット
                    const timeDisplay = appointment.time.substring(0, 5);
                    
                    // 予約内容の表示
                    appointmentEl.innerHTML = `
                        <strong>${timeDisplay}</strong> ${appointment.clientName}
                    `;
                    
                    // クリックで編集
                    appointmentEl.addEventListener('click', function(e) {
                        e.stopPropagation();
                        editAppointment(appointment.id);
                    });
                    
                    dayElement.appendChild(appointmentEl);
                }
            });
        }
        
        // 顧客管理関連の関数
        function renderClients() {
            const clientList = document.getElementById('client-list');
            clientList.innerHTML = '';
            
            if (clients.length === 0) {
                clientList.innerHTML = '<p>顧客データがありません。</p>';
                return;
            }
            
            // 顧客を五十音順にソート
            const sortedClients = [...clients].sort((a, b) => {
                const yomiA = a.nameYomi || '';
                const yomiB = b.nameYomi || '';
                return yomiA.localeCompare(yomiB, 'ja');
            });
            
            sortedClients.forEach(client => {
                // この顧客の予約を検索
                const clientAppointments = appointments.filter(apt => 
                    apt.phone === client.phone
                );
                
                // 顧客カードを作成
                const clientCard = document.createElement('div');
                clientCard.className = 'client-card';
                
                const clientContent = `
                    <div class="client-name">${client.name}</div>
                    <div class="client-info">
                        ${client.phone ? `<div>電話: ${client.phone}</div>` : ''}
                        ${client.nameYomi ? `<div>よみ: ${client.nameYomi}</div>` : ''}
                        ${client.notes ? `<div>メモ: ${client.notes}</div>` : ''}
                    </div>
                    <div class="client-appointments">
                        <strong>予約履歴 (${clientAppointments.length}件)</strong>
                        ${clientAppointments.length > 0 ? '<ul>' + 
                            clientAppointments.map(apt => {
                                const dateObj = new Date(apt.date);
                                const formattedDate = `${dateObj.getFullYear()}/${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
                                return `<li>${formattedDate} ${apt.time.substring(0, 5)} ${apt.notes ? `- ${apt.notes}` : ''}</li>`;
                            }).join('') + 
                          '</ul>' : '<p>予約履歴はありません。</p>'}
                    </div>
                    <div>
                        <button onclick="editClientById('${client.id}')">編集</button>
                        <button class="danger" onclick="confirmDeleteClient('${client.id}')">削除</button>
                    </div>
                `;
                
                clientCard.innerHTML = clientContent;
                clientList.appendChild(clientCard);
            });
        }
        
        function searchClients() {
            const searchTerm = document.getElementById('client-search').value.trim().toLowerCase();
            const clientList = document.getElementById('client-list');
            clientList.innerHTML = '';
            
            if (!searchTerm) {
                renderClients();
                return;
            }
            
            // 顧客を検索
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                (client.nameYomi && client.nameYomi.includes(searchTerm)) ||
                (client.phone && client.phone.includes(searchTerm)) ||
                (client.notes && client.notes.toLowerCase().includes(searchTerm))
            );
            
            if (filteredClients.length === 0) {
                clientList.innerHTML = '<p>検索結果はありません。</p>';
                return;
            }
            
            // 検索結果を五十音順にソート
            const sortedFilteredClients = [...filteredClients].sort((a, b) => {
                const yomiA = a.nameYomi || '';
                const yomiB = b.nameYomi || '';
                return yomiA.localeCompare(yomiB, 'ja');
            });
            
            // 検索結果を表示
            sortedFilteredClients.forEach(client => {
                // この顧客の予約を検索
                const clientAppointments = appointments.filter(apt => 
                    apt.phone === client.phone
                );
                
                // 顧客カードを作成
                const clientCard = document.createElement('div');
                clientCard.className = 'client-card';
                clientCard.style.borderLeft = '4px solid #ffeb3b'; // ハイライト表示
                
                const clientContent = `
                    <div class="client-name">${client.name}</div>
                    <div class="client-info">
                        ${client.phone ? `<div>電話: ${client.phone}</div>` : ''}
                        ${client.nameYomi ? `<div>よみ: ${client.nameYomi}</div>` : ''}
                        ${client.notes ? `<div>メモ: ${client.notes}</div>` : ''}
                    </div>
                    <div class="client-appointments">
                        <strong>予約履歴 (${clientAppointments.length}件)</strong>
                        ${clientAppointments.length > 0 ? '<ul>' + 
                            clientAppointments.map(apt => {
                                const dateObj = new Date(apt.date);
                                const formattedDate = `${dateObj.getFullYear()}/${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
                                return `<li>${formattedDate} ${apt.time.substring(0, 5)} ${apt.notes ? `- ${apt.notes}` : ''}</li>`;
                            }).join('') + 
                          '</ul>' : '<p>予約履歴はありません。</p>'}
                    </div>
                    <div>
                        <button onclick="editClientById('${client.id}')">編集</button>
                        <button class="danger" onclick="confirmDeleteClient('${client.id}')">削除</button>
                    </div>
                `;
                
                clientCard.innerHTML = clientContent;
                clientList.appendChild(clientCard);
            });
        }
        
        // 新規顧客モーダル表示（予約から自動的に表示する場合用）
        function showNewClientModal(client) {
            const modal = document.getElementById('client-modal');
            modal.style.display = 'block';
            
            // フォームをリセット
            document.getElementById('client-modal-title').textContent = '顧客情報登録';
            document.getElementById('modal-client-name').value = client.name || '';
            document.getElementById('modal-client-name-yomi').value = '';
            document.getElementById('modal-client-phone').value = client.phone || '';
            document.getElementById('modal-client-notes').value = '';
            document.getElementById('client-delete-btn').style.display = 'none';
            
            // 編集中の顧客をクリア（新規作成モード）
            currentClient = null;
            
            // フォームにフォーカス
            setTimeout(() => {
                document.getElementById('modal-client-name-yomi').focus();
            }, 100);
        }
        
        function showClientModal() {
            const modal = document.getElementById('client-modal');
            modal.style.display = 'block';
            
            // フォームをリセット
            document.getElementById('client-modal-title').textContent = '顧客情報';
            document.getElementById('modal-client-name').value = '';
            document.getElementById('modal-client-name-yomi').value = '';
            document.getElementById('modal-client-phone').value = '';
            document.getElementById('modal-client-notes').value = '';
            document.getElementById('client-delete-btn').style.display = 'none';
            
            // 編集中の顧客をクリア
            currentClient = null;
            
            // フォームにフォーカス
            setTimeout(() => {
                document.getElementById('modal-client-name').focus();
            }, 100);
        }
        
        function closeClientModal() {
            document.getElementById('client-modal').style.display = 'none';
            currentClient = null;
        }
        
        function editClientById(clientId) {
            // 顧客を検索
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // 編集対象の顧客を保存
            currentClient = client;
            
            // モーダルタイトルを更新
            document.getElementById('client-modal-title').textContent = '顧客情報編集';
            
            // フォームに値をセット
            document.getElementById('modal-client-name').value = client.name;
            document.getElementById('modal-client-name-yomi').value = client.nameYomi || '';
            document.getElementById('modal-client-phone').value = client.phone || '';
            document.getElementById('modal-client-notes').value = client.notes || '';
            
            // 削除ボタンを表示
            document.getElementById('client-delete-btn').style.display = 'inline-block';
            
            // モーダルを表示
            document.getElementById('client-modal').style.display = 'block';
        }
        
        function saveClient() {
            // ボタンを無効化して多重送信を防止
            document.getElementById('save-client-btn').disabled = true;
            
            // フォームから値を取得
            const name = document.getElementById('modal-client-name').value.trim();
            const nameYomi = document.getElementById('modal-client-name-yomi').value.trim();
            const phone = cleanPhoneNumber(document.getElementById('modal-client-phone').value.trim());
            const notes = document.getElementById('modal-client-notes').value.trim();
            
            // 必須項目のバリデーション
            if (!name) {
                alert('顧客名は必須です。');
                document.getElementById('save-client-btn').disabled = false;
                return;
            }
            
            if (!phone) {
                alert('電話番号は必須です。');
                document.getElementById('save-client-btn').disabled = false;
                return;
            }
            
            // よみがなのバリデーション
            if (!nameYomi) {
                alert('顧客名（よみ）は必須です。五十音順の並び替えに使用されます。');
                document.getElementById('save-client-btn').disabled = false;
                return;
            }
            
            // よみがながひらがなかどうかチェック
            if (!/^[\u3040-\u309F]+$/.test(nameYomi)) {
                alert('顧客名（よみ）はひらがなで入力してください。');
                document.getElementById('save-client-btn').disabled = false;
                return;
            }
            
            // 電話番号の重複チェック（編集時は自分自身を除外）
            const isDuplicate = clients.some(client => 
                client.phone === phone && 
                (!currentClient || client.id !== currentClient.id)
            );
            
            if (isDuplicate) {
                alert('この電話番号は既に登録されています。');
                document.getElementById('save-client-btn').disabled = false;
                return;
            }
            
            // 顧客データの準備
            const clientData = {
                name,
                nameYomi,
                phone,
                notes,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Firebase保存処理を開始
            let savePromise;
            let oldPhone = '';
            
            if (currentClient) {
                // 既存の顧客を更新
                oldPhone = currentClient.phone;
                savePromise = db.collection('clients').doc(currentClient.id).update(clientData);
            } else {
                // 新規顧客を作成
                clientData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                savePromise = db.collection('clients').add(clientData);
            }
            
            savePromise
                .then(() => {
                    // 顧客の電話番号が変更された場合、関連する予約も更新
                    if (currentClient && oldPhone !== phone) {
                        // 関連する予約を取得
                        const batch = db.batch();
                        
                        // クライアント側の予約データも更新
                        appointments.forEach(apt => {
                            if (apt.phone === oldPhone) {
                                // Firestoreでのバッチ更新用に予約参照を取得
                                const aptRef = db.collection('appointments').doc(apt.id);
                                batch.update(aptRef, { 
                                    clientName: name,
                                    phone: phone
                                });
                            }
                        });
                        
                        // バッチ処理を実行
                        return batch.commit();
                    }
                })
                .then(() => {
                    showNotification(currentClient ? '顧客情報を更新しました。' : '新規顧客を登録しました。');
                    closeClientModal();
                })
                .catch(error => {
                    console.error("Error saving client:", error);
                    alert('顧客情報の保存に失敗しました。再度お試しください。');
                })
                .finally(() => {
                    // ボタンを再有効化
                    document.getElementById('save-client-btn').disabled = false;
                });
        }
        
        function deleteClient() {
            if (!currentClient) return;
            
            if (confirm(`${currentClient.name}の顧客情報を削除してもよろしいですか？関連する予約も削除されます。`)) {
                // ボタンを無効化
                document.getElementById('client-delete-btn').disabled = true;
                
                // 関連する予約を検索
                const clientPhone = currentClient.phone;
                const relatedAppointments = appointments.filter(apt => apt.phone === clientPhone);
                
                // 顧客と関連予約を削除（バッチ処理）
                const batch = db.batch();
                
                // 顧客の削除
                const clientRef = db.collection('clients').doc(currentClient.id);
                batch.delete(clientRef);
                
                // 関連する予約の削除
                relatedAppointments.forEach(apt => {
                    const aptRef = db.collection('appointments').doc(apt.id);
                    batch.delete(aptRef);
                });
                
                // バッチ処理を実行
                batch.commit()
                    .then(() => {
                        showNotification('顧客情報と関連する予約を削除しました。');
                        closeClientModal();
                    })
                    .catch(error => {
                        console.error("Error deleting client:", error);
                        alert('削除に失敗しました。再度お試しください。');
                    })
                    .finally(() => {
                        // ボタンを再有効化
                        document.getElementById('client-delete-btn').disabled = false;
                    });
            }
        }
        
        function confirmDeleteClient(clientId) {
            // 顧客を検索
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            if (confirm(`${client.name}の顧客情報を削除してもよろしいですか？関連する予約も削除されます。`)) {
                // 関連する予約を検索
                const clientPhone = client.phone;
                const relatedAppointments = appointments.filter(apt => apt.phone === clientPhone);
                
                // 顧客と関連予約を削除（バッチ処理）
                const batch = db.batch();
                
                // 顧客の削除
                const clientRef = db.collection('clients').doc(clientId);
                batch.delete(clientRef);
                
                // 関連する予約の削除
                relatedAppointments.forEach(apt => {
                    const aptRef = db.collection('appointments').doc(apt.id);
                    batch.delete(aptRef);
                });
                
                // バッチ処理を実行
                batch.commit()
                    .then(() => {
                        showNotification('顧客情報と関連する予約を削除しました。');
                    })
                    .catch(error => {
                        console.error("Error deleting client:", error);
                        alert('削除に失敗しました。再度お試しください。');
                    });
            }
        }
        
        // 統計関連の関数
        function updateStats() {
            // 月間予約数をカウント
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonthIndex = today.getMonth();
            
            const monthlyAppointmentsCount = appointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate.getFullYear() === currentYear && 
                       aptDate.getMonth() === currentMonthIndex;
            }).length;
            
            document.getElementById('monthly-appointments').textContent = monthlyAppointmentsCount;
            
            // 顧客総数
            document.getElementById('total-clients').textContent = clients.length;
            
            // グラフ用のデータを作成
            const chartLabels = [];
            const chartData = [];
            
            for (let i = 0; i < 14; i++) {
                const date = new Date();
                date.setDate(date.getDate() - 7 + i);
                
                const dateString = formatDate(date);
                const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
                
                chartLabels.push(formattedDate);
                
                const count = appointments.filter(apt => apt.date === dateString).length;
                chartData.push(count);
            }
            
            // グラフを作成または更新
            const chartCanvas = document.getElementById('appointments-chart');
            
            if (window.appointmentChart) {
                window.appointmentChart.destroy();
            }
            
            window.appointmentChart = new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '予約数',
                        data: chartData,
                        backgroundColor: 'rgba(214, 98, 143, 0.5)',
                        borderColor: 'rgba(214, 98, 143, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // タブ関連の関数
        function openTab(evt, tabName) {
            // すべてのタブコンテンツを非表示
            const tabContent = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContent.length; i++) {
                tabContent[i].classList.remove('active');
            }
            
            // すべてのタブから active クラスを削除
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // 選択したタブのコンテンツを表示
            document.getElementById(tabName).classList.add('active');
            
            // クリックしたタブに active クラスを追加
            evt.currentTarget.classList.add('active');
            
            // 統計タブの場合は統計を更新
            if (tabName === 'stats-tab') {
                updateStats();
            }
        }
        
        // オフライン監視
        window.addEventListener('online', function() {
            updateSyncStatus('オンライン - 再接続中');
            // 再接続時にリスナーを再設定
            if (auth.currentUser) {
                setupRealtimeListeners();
            }
        });
        
        window.addEventListener('offline', function() {
            updateSyncStatus('オフライン - 変更は同期されません');
        });
        
        // サンプルデータの初期化（Firebaseに初期データがない場合）
        function createSampleData() {
            // Firestoreを確認して、データが存在しない場合のみ初期データを作成
            db.collection('clients').get().then(snapshot => {
                if (snapshot.empty) {
                    // サンプル顧客データ
                    const sampleClients = [
                        {
                            name: '佐藤 美咲',
                            nameYomi: 'さとうみさき',
                            phone: '09012345678',
                            notes: '敏感肌、フェイシャルオイルは使用しない',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        {
                            name: '田中 健太',
                            nameYomi: 'たなかけんた',
                            phone: '08087654321',
                            notes: '肩こりが酷い、強めのマッサージ希望',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        {
                            name: '鈴木 あかり',
                            nameYomi: 'すずきあかり',
                            phone: '09034567890',
                            notes: 'アロマはラベンダーが好み',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        {
                            name: '山田 和也',
                            nameYomi: 'やまだかずや',
                            phone: '08098765432',
                            notes: 'ギフト券利用あり',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    ];
                    
                    // サンプル顧客データをFirestoreに追加
                    const batch = db.batch();
                    
                    sampleClients.forEach(client => {
                        const clientRef = db.collection('clients').doc();
                        batch.set(clientRef, client);
                    });
                    
                    return batch.commit().then(() => {
                        console.log("Sample clients added to Firestore");
                        
                        // 顧客データが追加されたので、サンプル予約データを作成
                        return createSampleAppointments();
                    });
                }
            }).catch(error => {
                console.error("Error checking/creating sample data:", error);
            });
        }
        
        function createSampleAppointments() {
            // Firestoreから顧客データを取得して予約データを作成
            return db.collection('clients').get().then(snapshot => {
                if (!snapshot.empty) {
                    const clientsData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // 予約コレクションが空かどうかを確認
                    return db.collection('appointments').get().then(appointmentsSnapshot => {
                        if (appointmentsSnapshot.empty) {
                            // サンプル予約データを作成
                            const today = new Date();
                            const tomorrow = new Date();
                            tomorrow.setDate(today.getDate() + 1);
                            
                            const sampleAppointments = [
                                {
                                    clientName: clientsData[0].name,
                                    phone: clientsData[0].phone,
                                    date: formatDate(today),
                                    time: '13:00',
                                    notes: 'フェイシャルエステ（初回カウンセリング含む）',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                },
                                {
                                    clientName: clientsData[1].name,
                                    phone: clientsData[1].phone,
                                    date: formatDate(tomorrow),
                                    time: '15:30',
                                    notes: '肩と首のマッサージ（90分コース）',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                },
                                {
                                    clientName: clientsData[2].name,
                                    phone: clientsData[2].phone,
                                    date: formatDate(tomorrow),
                                    time: '10:00',
                                    notes: 'アロマオイルマッサージ（60分）',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                }
                            ];
                            
                            // サンプル予約データをFirestoreに追加
                            const batch = db.batch();
                            
                            sampleAppointments.forEach(appointment => {
                                const appointmentRef = db.collection('appointments').doc();
                                batch.set(appointmentRef, appointment);
                            });
                            
                            return batch.commit().then(() => {
                                console.log("Sample appointments added to Firestore");
                            });
                        }
                    });
                }
            });
        }
        
        // Firebaseセキュリティルール設定ヘルパー関数（管理者用）
        // この関数は開発時の利便性のために用意されていますが、本番環境では使用しないでください
        function setupFirebaseRules() {
            console.log(`
            // Firebaseコンソールで以下のセキュリティルールを設定してください
            
            rules_version = '2';
            service cloud.firestore {
              match /databases/{database}/documents {
                // 認証済みユーザーのみアクセス可能
                match /{document=**} {
                  allow read, write: if request.auth != null;
                }
                
                // 予約コレクション
                match /appointments/{appointmentId} {
                  allow read: if request.auth != null;
                  allow create: if request.auth != null && 
                                  request.resource.data.keys().hasAll(['clientName', 'phone', 'date', 'time']);
                  allow update: if request.auth != null && 
                                  request.resource.data.keys().hasAll(['clientName', 'phone', 'date', 'time']);
                  allow delete: if request.auth != null;
                }
                
                // 顧客コレクション
                match /clients/{clientId} {
                  allow read: if request.auth != null;
                  allow create: if request.auth != null && 
                                  request.resource.data.keys().hasAll(['name', 'nameYomi', 'phone']);
                  allow update: if request.auth != null && 
                                  request.resource.data.keys().hasAll(['name', 'nameYomi', 'phone']);
                  allow delete: if request.auth != null;
                }
              }
            }
            `);
        }
        
        // 初期ユーザー作成ヘルパー関数（管理者用）
        // この関数は開発時の利便性のために用意されていますが、本番環境では使用しないでください
        // Firebaseコンソールから直接ユーザーを作成することをお勧めします
        function createInitialUser() {
            console.log(`
            // Firebaseコンソールで以下の手順でユーザーを作成してください
            
            1. Firebase Consoleにログイン
            2. プロジェクトを選択
            3. 左メニューから「Authentication」を選択
            4. 「ユーザー」タブを選択
            5. 「ユーザーを追加」ボタンをクリック
            6. メールアドレスとパスワードを入力して追加
            
            テスト用ユーザーの例:
            - メールアドレス: salon@example.com
            - パスワード: SalonPass123!
            
            ※セキュリティのため、本番環境では強力なパスワードを使用してください
            `);
        }
    </script>
</body>
</html>
